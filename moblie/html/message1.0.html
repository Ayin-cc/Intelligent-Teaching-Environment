<!DOCTYPE html>
<html lang="zh-CN">

	<head>
		<meta charset="UTF-8">
		<meta name="viewport" content="width=device-width, initial-scale=1.0">
		<link href="../css/output.css" rel="stylesheet" />
		<title>ITE</title>
		<script src="../js/jquery-3.7.1.min.js"></script>
		<script>
			// 添加新消息
			function addNew(msgs) {
				for (var i = 0; i < msgs.length; i++) {
					var msg = msgs[i];
					setMessage(msg.id, msg.sender, msg.time, msg.title, msg.content);
				}
			}

			$(document).ready(function () {
				// 初始化消息列表
				$.ajax({
					type: "POST",
					dataType: "json",
					url: 'http://162.14.107.35/SCUEE/Student/initMsg',
					contentType: "application/json",
					data: "",
					success: function (result) {
						console.info(result);
						if (result != "") {
							addNew(result);
						}
					}
				})

				// 不断发送心跳包维持连接
				function keepAlive(callback) {
					setTimeout(function (){
						console.log("123");
						$.ajax({
							type: "POST",
							dataType: "json",
							url: 'http://162.14.107.35/SCUEE/DistrMsg/keepAlive',
							contentType: "application/json",
							data: "",
							success: function (result) {
								if (result != "") {
									addNew(result);
								}
							}
						})
						callback();
					}, 5000)
				}

				async function k(){
					keepAlive(k);
				}

				keepAlive(k);
			})
		</script>
	</head>

	<body class="w-screen">
		<!-- 顶部栏 -->

		<div class="flex flex-col w-screen h-12 bg-white" style="position: fixed;">
			<!-- 头像栏 -->
			<div class="flex items-center justify-center w-screen p-2 rounded-lg resizable">
				<h2 class="flex items-center justify-center overflow-hidden text-center rounded-lg hover:bg-gray-100 "
					id="class-message-button" style="white-space: nowrap;">
					通知
				</h2>
				<!-- 返回按键 -->
				<a href="../main.html"
					class="absolute items-center justify-end w-8 h-8 max-w-xs overflow-hidden rounded-h-full right-2"
					id="message-returnBottom">
					<img draggable="false" src="../icons/左.svg" alt="" />
				</a>
			</div>
			<!-- sidebar-line -->
			<div class="flex mx-2 w-auto h-0.5 bg-slate-400 "></div>
		</div>
		<div class="pt-12 mx-3">
			<!-- 通知 -->
			<div class="flex flex-col flex-grow w-screen h-full max-w-full max-h-full overflow-x-hidden overflow-y-scroll"
				id="class-message">
			</div>
		</div>
		<script>
			function setMessage(message_id, message_name, message_time, message_title, message_context) {
				var all_message = document.getElementById('class-message');

				all_message.innerHTML = `<div class="flex flex-col items-center w-full min-w-0 px-1 py-2 rounded-lg hover:bg-zinc-100" id="${message_id}"
								onclick="detail_message(${message_id})">
					<div class="flex w-full" onclick="detail_message(${message_id})">
						<div class="flex items-center justify-center w-12 h-12" onclick="detail_message(${message_id})">
							<div class="flex items-center justify-center w-10 h-10 bg-red-500 rounded-xl">
								<img draggable="false" class="w-8 h-8 p-1" src="../icons/ffffff/邮件.svg">
							</div>
						</div>
						<div class="flex flex-col whitespace-nowrap" onclick="detail_message(${message_id})">
							<div class="flex flex-row" onclick="detail_message(${message_id})">
								<div class="px-2 font-bold truncate" style="max-width: 80px;">
									${message_title}
									</div>
								<div onclick="detail_message(${message_id})"
									class="absolute flex items-end justify-end pt-2 text-xs min-w-max text-zinc-400 text-end right-4">
									${message_time}
									</div>
							</div>
							<div class="px-2 overflow-hidden overflow-ellipsis text-slate-600 w-72 whitespace-nowrap"
								onclick="detail_message(${message_id})">
								${message_name}
								</div>
						</div>
					</div>
					<div onclick="detail_message(${message_id})"
						class="w-full pr-2 overflow-hidden text-sm pl-14 overflow-ellipsis text-slate-400 whitespace-nowrap">
						${message_context}
						</div>
					 <div class="flex h-0.5 w-64 bg-slate-100 mt-1" onclick="detail_message(${message_id})"></div>
				</div>`;
			}
			setMessage(1, 2, 3, 3, 4);

			function detail_message(mids) {
				sessionStorage.setItem('mid', mids);
				console.log('被点击的链接的id是：' + mids);
				window.location.href = 'message_view.html';
			}

		</script>
		<script>
			$(document).ready(function () {
				// 检测cookie信息
			})
		</script>
	</body>

</html>