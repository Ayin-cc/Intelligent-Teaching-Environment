<!DOCTYPE html>
<html lang="zh-CN">

	<head>
		<meta charset="UTF-8">
		<meta name="viewport" content="width=device-width, initial-scale=1.0">
		<title>登录</title>
		<link href="../css/output.css" rel="stylesheet">
		<script src="../js/jquery-3.7.1.min.js"></script>
		<script src="../js/cookie-utils.js"></script>
	</head>

	<body class="flex items-center justify-center min-h-screen bg-gray-100">
		<div class="p-8 bg-white shadow-xl w-80 rounded-xl">
			<h2 class="text-2xl font-semibold" id="top-tip">登录</h2>
			<form class="mt-10">
				<div class="mb-4">
					<!-- <label for="username" class="block mb-2 font-medium text-gray-600">学工号</label> -->
					<input type="text" id="username" name="username" placeholder="学号"
						class="w-full p-2 my-2 border border-gray-300 rounded-md focus:bg-slate-100 bg-slate-50 focus:outline-none focus:border-blue-500">
				</div>
				<div class="mb-4">
					<!-- <label for="password" class="block mb-2 font-medium text-gray-600">密码</label> -->
					<input type="password" id="password" name="password" placeholder="密码"
						class="w-full p-2 my-2 border border-gray-300 rounded-md focus:bg-slate-100 bg-slate-50 focus:outline-none focus:border-blue-500">
				</div>
				<div class="hidden mb-4" id="pswd-again">
					<!-- <label for="password" class="block mb-2 font-medium text-gray-600">确认密码</label> -->
					<input type="password" id="password-confirm" name="password" placeholder="确认密码"
						class="w-full p-2 my-2 border border-gray-300 rounded-md focus:bg-slate-100 bg-slate-50 focus:outline-none focus:border-blue-500">
				</div>
				<div class="flex items-center justify-end mt-12 mb-4">
					<!-- <div class="flex items-end justify-end text-blue-500" id="reset-password">
						忘记密码？
					</div> -->
					<button id="sign-button"
						class="flex items-end px-4 py-2 text-white bg-blue-400 rounded-md focus:outline-none focus:bg-blue-600">
						注册
					</button>
					<button id="log-button"
						class="flex items-end px-4 py-2 ml-10 text-white bg-blue-500 rounded-md focus:outline-none focus:bg-blue-600">
						登录
					</button>
				</div>
			</form>
		</div>
		<script>
			const top_tip = document.getElementById('top-tip');
			const pswd_again = document.getElementById('pswd-again');
			const sign_button = document.getElementById('sign-button');
			const log_button = document.getElementById('log-button');
			// const reset_password = document.getElementById('reset-password');
			var log_sin_status = 1;

			function change_top_tip() {
				if (log_sin_status == 1) {
					top_tip.textContent = '登录';
					pswd_again.classList.add('hidden');
				} else if (log_sin_status == 0) {
					top_tip.textContent = '注册';
					pswd_again.classList.remove('hidden');
					// reset_password.classList.add('hidden');
				}
			}

			// 注册按钮
			sign_button.addEventListener('click', () => {
				event.preventDefault();
				if (log_sin_status == 1) {
					log_sin_status = 0;
					change_top_tip();
					passwdConfirm.value = '';
					sign_button.classList.remove('bg-blue-400');
					sign_button.classList.add('bg-blue-500');
					log_button.classList.add('hidden');
					sign_button.blur();
				} else {
					register();
				}
			});

			// 登录按钮
			log_button.addEventListener('click', () => {
				event.preventDefault();
				/*
				log_sin_status = 1;
				change_top_tip();
				*/
				login();
			});

			// 初始化
			change_top_tip();
		</script>
		<script>
			// 验证通过，进入主界面
			function enter(userId, passwd) {
				var token;
				// 获取token
				$.ajax({
					type: "POST",
					dataType: "json",
					url: 'http://162.14.107.35/SCUEE/CourseSchedule/get',
					contentType: "application/json",
					data: JSON.stringify({ "sid": userId }),
					success: function (result) {
						token = result.token;
					}
				})
				// 将相关信息存入cookie
				setCookie(userId, token);
				sessionStorage.setItem('mid', '0');
				sessionStorage.setItem('is_signed', 'false');
				// 进入主界面
				window.location.href = "../main.html";
			}


			const userId = document.getElementById("username");
			const passwd = document.getElementById("password");
			const passwdConfirm = document.getElementById("password-confirm");

			// 输入框 是否已输入 监测
			var isUserID = 0;
			var isPasswd = 0;
			var isPasswdConfirm = 0;
			//单个输入框的检测
			function isInput(input) {
				if ((input.value).trim() !== "") {
					return 1;
				} else {
					return 0;
				}
			}
			// 所有输入框均输入 注册按钮样式修改
			function isAllInput() {
				var inputAll = isUserID + isPasswd + isPasswdConfirm;
				if (inputAll !== 3) {
					sign_button.classList.remove("bg-blue-500");
					sign_button.classList.add("bg-blue-200");
					//sendButton.disabled = true;
				} else {
					sign_button.classList.remove("bg-blue-200");
					sign_button.classList.add("bg-blue-500");
					//sendButton.disabled = true;
				}
			}

			// 初始化 注册按钮 样式
			isAllInput();
			// 检测各输入框内容
			userId.addEventListener("input", function () {
				isUserID = isInput(userId);
				isAllInput();
			});
			passwd.addEventListener("input", function () {
				isPasswd = isInput(passwd);
				isAllInput();
			});
			passwdConfirm.addEventListener("input", function () {
				isPasswdConfirm = isInput(passwdConfirm);
				isAllInput();
			});

			// 登录功能
			function login() {
				if (userId.value == '' || passwd.value == '') {
					alert("学号或密码不能为空！");
					log_button.blur();
					return;
				}
				$.ajax({
					type: "POST",
					dataType: "json",
					url: 'http://162.14.107.35/SCUEE/user/loginStudent',
					contentType: "application/json",
					data: JSON.stringify({ "sid": userId, "passwd": passwd }),
					success: function (result) {
						if (result == 1) {
							enter(userId, passwd);
						}
						if (result == 0) {
							alert("登录失败！请检查账号密码是否正确！");
						}
					}
				})
				log_button.blur();
			}

			// 注册功能
			function register() {
				if (userId.value == '' || passwd.value == '') {
					return;
				} else if (passwd.value != passwdConfirm.value) {
					alert("密码不一致！");
				} else {
					$.ajax({
						type: "POST",
						dataType: "json",
						url: 'http://162.14.107.35/SCUEE/user/loginStudent',
						contentType: "application/json",
						data: JSON.stringify({ "sid": userId, "passwd": passwd }),
						success: function (result) {
							if (result == 200) {
								enter(userId, passwd);
							}
							if (result == 401) {
								alert("注册失败！用户已存在！");
							}
						}
					})
				}
				sign_button.blur();

			}
		</script>
	</body>

</html>