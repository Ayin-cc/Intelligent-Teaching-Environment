<!DOCTYPE html>
<html lang="zh-CN">

	<head>
		<meta charset="UTF-8">
		<meta name="viewport" content="width=device-width, initial-scale=1.0">
		<title>登录</title>
		<link href="../css/output.css" rel="stylesheet">
		<script src="../js/jquery-3.7.1.min.js"></script>
		<script src="../js/cookie-utils.js"></script>
		<script>
			$(document).ready(function () {
			})
		</script>
	</head>

	<body class="flex items-center justify-center min-h-screen bg-gray-100">
		<div class="p-8 bg-white shadow-xl w-80 rounded-xl">
			<h2 class="text-2xl font-semibold" id="top-tip">登录</h2>
			<form class="mt-10">
				<div class="mb-4">
					<label for="username" class="block mb-2 font-medium text-gray-600">学工号</label>
					<input type="text" id="username" name="username"
						class="w-full p-2 border border-gray-300 rounded-md focus:bg-slate-100 bg-slate-50 focus:outline-none focus:border-blue-500 ">
				</div>
				<div class="mb-4">
					<label for="password" class="block mb-2 font-medium text-gray-600">密码</label>
					<input type="password" id="password" name="password"
						class="w-full p-2 border border-gray-300 rounded-md focus:bg-slate-100 bg-slate-50 focus:outline-none focus:border-blue-500">
				</div>
				<div class="hidden mb-4" id="pswd-again">
					<label for="password" class="block mb-2 font-medium text-gray-600">确认密码</label>
					<input type="password" id="password-confirm" name="password"
						class="w-full p-2 border border-gray-300 rounded-md focus:bg-slate-100 bg-slate-50 focus:outline-none focus:border-blue-500">
				</div>
				<div class="flex items-center justify-end mt-12 mb-4">
					<!-- <div class="flex items-end justify-end text-blue-500" id="reset-password">
						忘记密码？
					</div> -->
					<button id="sign-button"
						class="flex items-end px-4 py-2 text-white bg-blue-400 rounded-md focus:outline-none focus:bg-blue-600">
						注册
					</button>
					<button id="log-button"
						class="flex items-end px-4 py-2 ml-10 text-white bg-blue-500 rounded-md focus:outline-none focus:bg-blue-600">
						登录
					</button>
				</div>
			</form>
		</div>
		<script>
			// 验证通过，进入主界面
			function enter(userId, passwd) {
				var token;
				// 获取token
				$.ajax({
					type: "POST",
					dataType: "json",
					url: 'http://162.14.107.35/SCUEE/CourseSchedule/get',
					contentType: "application/json",
					data: JSON.stringify({ "sid": userId }),
					success: function (result) {
						token = result.token;
					}
				})
				// 将相关信息存入cookie
				setCookie(userId, token);
				sessionStorage.setItem('mid', '0');
				sessionStorage.setItem('is_signed', 'false');
				// 进入主界面
				window.location.href = "../main.html";
			}

			// 登录功能
			function login() {
				const userId = document.getElementById("username");
				const passwd = document.getElementById("password");
				$.ajax({
					type: "POST",
					dataType: "json",
					url: 'http://162.14.107.35/SCUEE/user/loginStudent',
					contentType: "application/json",
					data: JSON.stringify({ "sid": userId, "passwd": passwd }),
					success: function (result) {
						if (result == 1) {
							enter(userId, passwd);
						}
						if (result == 0) {
							alert("登录失败！请检查账号密码是否正确！");
						}
					}
				})
			}

			// 注册功能
			function register() {
				const userId = document.getElementById("username").value;
				const passwd = document.getElementById("password").value;
				const passwdConfirm = document.getElementById("password-confirm").value;
				if (passwd == '') {
					alert("密码不能为空！");
					return;
				} else if (passwd != passwdConfirm) {
					alert("密码不一致！");
					return;
				}
				$.ajax({
					type: "POST",
					dataType: "json",
					url: 'http://162.14.107.35/SCUEE/user/loginStudent',
					contentType: "application/json",
					data: JSON.stringify({ "sid": userId, "passwd": passwd }),
					success: function (result) {
						if (result == 200) {
							enter(userId, passwd);
						}
						if (result == 401) {
							alert("注册失败！用户已存在！");
						}
					}
				})
			}
		</script>
		<script>
			const top_tip = document.getElementById('top-tip');
			const pswd_again = document.getElementById('pswd-again');
			const sign_button = document.getElementById('sign-button');
			const log_button = document.getElementById('log-button');
			// const reset_password = document.getElementById('reset-password');
			var log_sin_status = 1;

			function change_top_tip() {
				if (log_sin_status == 1) {
					top_tip.textContent = '登录';
					pswd_again.classList.add('hidden');
				} else if (log_sin_status == 0) {
					top_tip.textContent = '注册';
					pswd_again.classList.remove('hidden');
					// reset_password.classList.add('hidden');
				}
			}

			sign_button.addEventListener('click', () => {
				event.preventDefault();
				if (log_sin_status == 1) {
					log_sin_status = 0;
					change_top_tip();
					log_button.classList.add('hidden');
				} else register();
			});
			log_button.addEventListener('click', () => {
				event.preventDefault();
				/*
				log_sin_status = 1;
				change_top_tip();
				*/
				login();
			});

			// 初始化
			change_top_tip();


		</script>
	</body>

</html>