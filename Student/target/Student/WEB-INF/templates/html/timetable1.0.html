<!DOCTYPE html>
<html lang="zh-CN">

	<head>
		<meta charset="UTF-8">
		<meta name="viewport" content="width=device-width, initial-scale=1.0">
		<title>ITE-课表</title>
		<link href="../css/output.css" rel="stylesheet" />
		<script src="../js/jquery-3.7.1.min.js"></script>
		<script src="../js/cookie-utils.js"></script>
		<script>
			var student;
			$(document).ready(async function () {
				// 检测cookie信息
				checkCookie();
				student = await getStudentObj();
				// 使用学生对象替换页面中的值
				const stdName = document.getElementById('name-profile');
				const stdID = document.getElementById('number-profile');
				stdName.textContent = student.name;
				stdID.textContent = student.sid;
			})
		</script>
	</head>

	<body>
		<!-- 顶部栏 -->
		<div class="flex flex-col">
			<div class="flex flex-row items-center">
				<!-- 头像栏 -->
				<div class="flex items-center justify-center max-w-xs p-2 rounded-lg resizable">
					<!-- 头像框 -->
					<div class="flex w-8 h-10 mx-4 overflow-hidden rounded-full" id="photo-profile">
						<img draggable="false" src="../icons/用户.svg" alt="" />
					</div>
					<div>
						<!-- 姓名 -->
						<div class="flex flex-grow mx-6 overflow-hidden select-none" id="name-profile">
							XYCF
						</div>

						<!-- 学号 -->
						<div class="flex flex-grow py-1 overflow-hidden text-xs select-none" id="number-profile">
							2022xxxxxxxxx
						</div>
					</div>

				</div>

				<div class="flex flex-grow"></div>
				<div class="absolute flex flex-row text-sm select-none right-14" id="college-choice">
					<div class="hidden ml-1 font-light" id="jiangan">江安</div>
					<div class="hidden ml-1 font-light" id="wangjiang">望江</div>
					<div class="hidden ml-1 font-light" id="huaxi">华西</div>
					<div class="ml-2 mr-4 text-base select-none font-backdrop-sepia-0" id="xiaoqu">江安</div>
				</div>
				<div class="absolute w-8 h-8 p-2 mx-2 rounded-lg hover:bg-slate-100 right-8" id="refresh-menu-header">
					<img draggable="false" src="../icons/刷新.svg" alt="" srcset="" />
				</div>
				<a href="main.html"
					class="absolute items-center justify-end w-8 h-8 max-w-xs overflow-hidden rounded-h-full right-2"
					id="timetable-returnBottom">
					<img draggable="false" src="../icons/左.svg" alt="" />
				</a>

			</div>
			<!-- sidebar-line -->
			<div class="flex mx-2 w-auto h-0.5 bg-slate-400 "></div>
		</div>
		<div class="container flex items-center justify-center mx-auto my-4 text-sm">
			<table class="text-center border border-collapse border-gray-400" id="class-table" style="width: 97%">
				<thead>
					<tr class="bg-gray-200">
						<th class="border border-gray-400 "></th>
						<th class="p-2 border border-gray-400">周一</th>
						<th class="p-2 border border-gray-400">周二</th>
						<th class="p-2 border border-gray-400">周三</th>
						<th class="p-2 border border-gray-400">周四</th>
						<th class="p-2 border border-gray-400">周五</th>
						<th class="p-2 border border-gray-400">周六</th>
						<th class="p-2 border border-gray-400">周日</th>
					</tr>
				</thead>

				<tbody class="text-xs text-gray-600" id="table-body">

				</tbody>
			</table>
		</div>
	</body>
	<script type="text/javascript">


		// 判断日期是否在本周
		function isCurrentWeek(past) {
			const pastTime = new Date(past).getTime()
			const today = new Date(new Date().toLocaleDateString())
			let day = today.getDay()
			day = day == 0 ? 7 : day
			const oneDayTime = 60 * 60 * 24 * 1000
			const monday = new Date(today.getTime() - (oneDayTime * (day - 1)))
			const nextMonday = new Date(today.getTime() + (oneDayTime * (8 - day)))
			if (monday.getTime() <= pastTime && nextMonday.getTime() > pastTime) {
				return true
			} else {
				return false
			}
		}

		// 解析课表数据
		function parmCourse(courses) {
			for (var i = 0; i < courses.length; i++) {
				var dates = courses[i].date;
				var j = 0;
				while (j < dates.length) {
					if (isCurrentWeek(dates[j])) {
						var day = new Date(dates[j]).getDay();
						if (day == 0) day = 7;
						for (var k = courses[i].startSection; k <= courses[i].endSection; k++) {
							var courseName = document.getElementById(day.toString() + "-" + k.toString() + "-1");
							var courseSite = document.getElementById(day.toString() + "-" + k.toString() + "-2");
							var courseTeacher = document.getElementById(day.toString() + "-" + k.toString() + "-3");
							courseName.innerHTML = courses[i].name;
							courseSite.innerHTML = courses[i].site;
							courseTeacher.innerHTML = courses[i].teacher;
						}
					}
					j++;
				}
			}
		}

		// 获取课表数据
		function getCourse() {
			const sid = student.sid;
			console.log(sid);
			$.ajax({
				type: "POST",
				dataType: "json",
				url: 'http://162.14.107.35/SCUEE/CourseSchedule/get',
				contentType: "application/json",
				data: JSON.stringify({ "sid": sid }),
				success: function (result) {
					parmCourse(result);
				}
			})
		}

		// 按钮 主动刷新 获取课表数据
		const refresh = document.getElementById('refresh-menu-header');
		refresh.addEventListener('click', () => { getCourse(); });
	</script>
	<script>
		// 生成表格
		{
			function setNewtr_spc(time) {
				const newtd = document.createElement('td');
				// 设置元素的属性
				newtd.setAttribute('class', 'text-xs text-center bg-gray-300 w-full');
				newtd.setAttribute('colspan', '8');
				// 设置元素的文本内容
				if (time == 1) newtd.textContent = '午休';
				else if (time == 2) newtd.textContent = '晚休';
				// 将新的 div 元素添加到页面中的容器中
				const tbody = document.getElementById('table-body');
				tbody.appendChild(newtd);
			}

			function setNewtr(n) {
				for (let i = 1; i <= n; i++) {
					if (i == 5) setNewtr_spc(1);
					else if (i == 10) setNewtr_spc(2);
					const newtr = document.createElement('tr');
					const trId = `row${i}`;
					// 设置元素的属性
					newtr.setAttribute('id', trId);
					newtr.setAttribute('class', 'text-center h-20');

					// 设置元素的文本内容
					// newtr.textContent = i;
					// 将新的 div 元素添加到页面中的容器中
					const tbody = document.getElementById('table-body');
					tbody.appendChild(newtr);
					setNewtd(i, 8);
				}
			}

			function setNewtd(i, n) {
				for (let j = 0; j < n; j++) {
					const newtd = document.createElement('td');
					const tdId = `${i}-${j}`;

					// 设置元素的属性
					newtd.setAttribute('id', tdId);
					newtd.setAttribute('class', 'text-xs border border-gray-400 text-center');

					// 设置元素的文本内容
					// newtd.textContent = j;
					// 将新的 div 元素添加到页面中的容器中
					const trId = `row${i}`;
					const tr = document.getElementById(trId);
					tr.appendChild(newtd);
					setNewp(i, j, 3);
				}
			}

			function setNewp(i, j, n) {
				let k = 1;
				if (j == 0) {
					for (; k <= n; k++) {
						const newp = document.createElement('p');
						const pId = `${j}-${i}-${k}`;

						// 设置元素的属性
						newp.setAttribute('id', pId);
						if (k != 1) {
							newp.setAttribute('class', 'my-1 text-xs text-gray-400');
							// 设置元素的文本内容
						} else if (k == 1) {
							newp.textContent = `${i}`;
							newp.setAttribute('class', 'my-3 text-black');
						}
						// 将新的 div 元素添加到页面中的容器中
						const tdId = `${i}-${j}`;
						const td = document.getElementById(tdId);
						td.appendChild(newp);
					}
				} else {
					for (; k <= n; k++) {
						const newp = document.createElement('p');
						const pId = `${j}-${i}-${k}`;

						// 设置元素的属性
						newp.setAttribute('id', pId);
						// 设置元素的文本内容
						newp.textContent = ``;
						// 将新的 div 元素添加到页面中的容器中
						const tdId = `${i}-${j}`;
						const td = document.getElementById(tdId);
						td.appendChild(newp);
					}
				}
			}
		}

		// 更改校区对应的时间
		{
			// 控制的按钮
			const box1 = document.getElementById('college-choice');
			const box2 = document.getElementById('xiaoqu');
			const boxA = document.getElementById('jiangan');
			const boxB = document.getElementById('wangjiang');
			const boxC = document.getElementById('huaxi');
			let visibleBox;
			let now = box2.textContent;

			function hidden_all() {
				boxA.classList.add('hidden');
				boxB.classList.add('hidden');
				boxC.classList.add('hidden');
			}

			function shown_all() {
				now = box2.textContent;
				boxA.classList.remove('hidden');
				boxB.classList.remove('hidden');
				boxC.classList.remove('hidden');
				if (now === '江安') {
					boxA.classList.add('hidden');
				} else if (now === '望江') {
					boxB.classList.add('hidden');
				} else if (now === '华西') {
					boxC.classList.add('hidden');
				}

			}

			function change_choice(abc) {
				if (abc == 1) {
					now = '江安';
				} else if (abc == 2) {
					now = '望江';
				} else if (abc == 3) {
					now = '华西';
				}
				box2.textContent = now;
				hidden_all();
			}

			box2.addEventListener('click', () => {
				// 如果所有选项都未隐藏
				if (boxA.classList.contains('hidden') && boxB.classList.contains('hidden') && boxC.classList.contains('hidden')) {
					shown_all();
					now = box2.textContent;
				} else {
					hidden_all();
				}
			});

			boxA.addEventListener('click', () => {
				change_choice(1);
				change_time(1)
			});
			boxB.addEventListener('click', () => {
				change_choice(2);
				change_time(2)
			});
			boxC.addEventListener('click', () => {
				change_choice(3);
				change_time(2)
			});

			function change_time(which_college) {
				const box1_1 = document.getElementById('0-1-2');
				const box2_1 = document.getElementById('0-1-3');

				const box1_2 = document.getElementById('0-2-2');
				const box2_2 = document.getElementById('0-2-3');

				const box1_3 = document.getElementById('0-3-2');
				const box2_3 = document.getElementById('0-3-3');

				const box1_4 = document.getElementById('0-4-2');
				const box2_4 = document.getElementById('0-4-3');

				const box1_5 = document.getElementById('0-5-2');
				const box2_5 = document.getElementById('0-5-3');

				const box1_6 = document.getElementById('0-6-2');
				const box2_6 = document.getElementById('0-6-3');

				const box1_7 = document.getElementById('0-7-2');
				const box2_7 = document.getElementById('0-7-3');

				const box1_8 = document.getElementById('0-8-2');
				const box2_8 = document.getElementById('0-8-3');

				const box1_9 = document.getElementById('0-9-2');
				const box2_9 = document.getElementById('0-9-3');

				const box1_10 = document.getElementById('0-10-2');
				const box2_10 = document.getElementById('0-10-3');

				const box1_11 = document.getElementById('0-11-2');
				const box2_11 = document.getElementById('0-11-3');

				const box1_12 = document.getElementById('0-12-2');
				const box2_12 = document.getElementById('0-12-3');

				if (which_college === 1) {
					box1_1.textContent = '8:15';
					box2_1.textContent = '9:00';

					box1_2.textContent = '9:10';
					box2_2.textContent = '9:55';

					box1_3.textContent = '10:15';
					box2_3.textContent = '11:00';

					box1_4.textContent = '11:10';
					box2_4.textContent = '11:55';

					box1_5.textContent = '13:50';
					box2_5.textContent = '14:35';

					box1_6.textContent = '14:45';
					box2_6.textContent = '15:30';

					box1_7.textContent = '15:40';
					box2_7.textContent = '16:25';

					box1_8.textContent = '16:45';
					box2_8.textContent = '17:30';

					box1_9.textContent = '17:40';
					box2_9.textContent = '18:25';

					box1_10.textContent = '19:20';
					box2_10.textContent = '20:05';

					box1_11.textContent = '20:15';
					box2_11.textContent = '21:00';

					box1_12.textContent = '21:10';
					box2_12.textContent = '21:55';
				} else {
					box1_1.textContent = '8:00';
					box2_1.textContent = '8:45';

					box1_2.textContent = '8:55';
					box2_2.textContent = '9:40';

					box1_3.textContent = '10:00';
					box2_3.textContent = '10:45';

					box1_4.textContent = '10:55';
					box2_4.textContent = '11:40';

					box1_5.textContent = '14:00';
					box2_5.textContent = '14:45';

					box1_6.textContent = '14:55';
					box2_6.textContent = '15:40';

					box1_7.textContent = '15:50';
					box2_7.textContent = '16:35';

					box1_8.textContent = '16:55';
					box2_8.textContent = '17:40';

					box1_9.textContent = '17:50';
					box2_9.textContent = '18:35';

					box1_10.textContent = '19:30';
					box2_10.textContent = '20:15';

					box1_11.textContent = '20:25';
					box2_11.textContent = '21:10';

					box1_12.textContent = '21:20';
					box2_12.textContent = '22:05';
				}
			}
		}
		let which_college = 1;
		setNewtr(12);
		change_time(which_college);
		getCourse();
	</script>

</html>