<!DOCTYPE html>
<html lang="zh-CN">

    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>ITE</title>
        <link href="../css/output.css" rel="stylesheet" />
        <script src="../js/jquery-3.7.1.min.js"></script>
        <script src="../js/cookie-utils.js"></script>
        <script>
            var student;
            function getdetail_mes() {
                var mids = sessionStorage.getItem('mid');
                console.log("id:" + mids);
                return mids;
            }

            $(document).ready(async function () {
                // 检测 cookie 是否过期
                checkCookie();
                student = await getStudentObj();

                $.ajax({
                    type: "POST",
                    dataType: "json",
                    url: 'http://162.14.107.35/SCUEE/DistrMsg/get',
                    contentType: "application/json; charset=UTF-8",
                    data: JSON.stringify({ "id": getdetail_mes() }),
                    success: function (result) {
                        if (result) {
                            var title = result.title;
                            var content = result.content;
                            var time = result.time;
                            var sender = result.sender;
                            var attachment = result.attachment;
                            console.log(result);
                            document.getElementById("message-title").innerHTML = title;
                            document.getElementById("message-content").innerHTML = content;
                            document.getElementById("message-time").innerHTML = time;
                            document.getElementById("message-sender").innerHTML = sender;
                            document.getElementById("message-sender-out").innerHTML = sender;
                            if (attachment[0].file == null) {
                                attachment = null;
                            }
                            else {
                                // 添加附件
                                document.getElementById("attched-tip-num").innerHTML = attachment.length;
                                for (var i = 0; i < attachment.length; i++) {
                                    var blob = new Blob([new TextEncoder().encode(attachment[i].file)], { type: 'application/octet-stream; charset=GBK' });
                                    var blobUrl = URL.createObjectURL(blob);
                                    isAttached(attachment.length, blobUrl, attachment[i].name);
                                }
                            }
                        }
                    }
                })
            })
        </script>
    </head>

    <body class="w-screen">
        <div class="flex flex-col w-screen h-12 bg-white">
            <!-- 头像栏 -->
            <div class="flex items-center justify-center w-screen p-2 rounded-lg resizable">
                <h2 class="flex items-center justify-center overflow-hidden text-center rounded-lg hover:bg-gray-100 "
                    id="class-message-button" style="white-space: nowrap;">
                    通知
                </h2>
                <!-- 返回按键 -->
                <a href="./message1.0.html"
                    class="absolute items-center justify-end w-8 h-8 max-w-xs overflow-hidden rounded-h-full right-2"
                    id="message-returnBottom">
                    <img draggable="false" src="../icons/左.svg" alt="" />
                </a>
            </div>
            <!-- sidebar-line -->
            <div class="flex mx-2 w-auto h-0.5 bg-slate-400 "></div>
        </div>

        <!-- 通知 -->
        <div class="flex flex-col flex-grow w-screen h-full max-w-full max-h-full px-3 overflow-x-hidden overflow-y-scroll"
            id="class-message">
            <div class="flex flex-row">
                <div class="flex px-2 pt-2 text-lg" id="message-title">
                    标题
                </div>
                <div class="flex flex-grow"></div>
                <!-- <div class="flex items-end px-3 pt-2 text-sm text-gray-400 text-end"
                    id="message-time">
                    time
                </div> -->
            </div>

            <div class="flex flex-col mb-2">
                <!-- 具体的相关信息 -->
                <div class="absolute flex mx-3 overflow-hidden text-sm text-blue-600 rounded-lg right-2"
                    id="details-button">
                    显示
                </div>
                <!-- 发件人 -->
                <div class="flex mb-2 " id="brief-inf">
                    <div class="mr-1 overflow-hidden text-sm text-green-600 rounded-lg select-none flexml-6"
                        id="message-sender-out">
                        发件人
                    </div>
                    <div class="flex" id="attched-tip-brf">
                        <img draggable="false" class="flex" style="max-width: 20px;" src="../icons/附件.svg" alt="" />
                        <div class="flex overflow-hidden text-sm select-none" id="attched-tip-num">
                            无附件
                        </div>
                    </div>

                </div>

                <div id="detail-inf" class="hidden w-full ">
                    <!-- 发件人 & 时间 -->
                    <div class="flex w-full mx-5 my-2 overflow-hidden text-xs">
                        <div class="w-12 text-gray-400 text-end">发件人:</div>
                        <div class="ml-2 overflow-hidden text-gray-600 text-start" style="max-width: calc(220px);"
                            id="message-sender">
                            XX科
                        </div>
                    </div>
                    <div class="flex mx-5 my-2 overflow-hidden text-xs">
                        <div class="w-12 text-gray-400 text-end">时间:</div>
                        <div class="ml-2 text-gray-600 text-start" id="message-time">2022.4.16</div>
                    </div>
                    <!-- 附件 -->
                    <div class="flex mx-5 my-2 overflow-hidden text-xs" style="max-width: calc(100%-20px);">
                        <div class="w-12 text-gray-400 text-end" id="attched_tips">附件:</div>
                        <div class="flex flex-col mb-1 overflow-hidden" style="max-width: calc(100%-100px);"
                            id="attchment">
                            <!-- <div class="flex mb-1 overflow-hidden" style="max-width: calc(100vw - 110px);">
                                【
                                <div class="overflow-hidden text-blue-500 overflow-ellipsis whitespace-nowrap"
                                    style="max-width:  calc(100% - 10px);" onclick="clicklink(link)">
                                    XXXX.pdf
                                </div>
                                】
                            </div> -->
                        </div>
                    </div>

                </div>
                <div class="flex mx-2 w-auto h-0.5 bg-slate-100  mb-2"></div>
                <!-- 正文 -->
                <div class="flex px-3 mb-8 overflow-hidden rounded-lg" id="message-content">
                    正文：
                </div>
                <div class="flex flex-grow"></div>

            </div>

        </div>
        <script>
            // 控制相关信息的隐藏与否
            var isShow = 1;
            const details_button = document.getElementById('details-button');
            const attched_button = document.getElementById('attched-tip-brf');
            const detail_inf = document.getElementById('detail-inf');
            const brief_inf = document.getElementById('brief-inf');
            function isShows() {
                if (isShow == 0) {
                    details_button.textContent = '隐藏';
                    detail_inf.classList.remove('hidden');
                    brief_inf.classList.add('hidden');
                    isShow = 1;
                } else if (isShow == 1) {
                    details_button.textContent = '显示';
                    brief_inf.classList.remove('hidden');
                    detail_inf.classList.add('hidden');
                    isShow = 0;
                }
            }
            details_button.addEventListener('click', () => {
                isShows();
            });
            attched_button.addEventListener('click', () => {
                isShows();
            });

            // 确认附件数量
            function isAttached(attched_number, blobUrl = '', attachment_name = '') {
                const attched_brf = document.getElementById('attched-tip-brf');
                const attched_tips = document.getElementById('attched_tips');
                const attched_num = document.getElementById('attched-tip-num');
                if (attched_number == 0) {
                    attched_tips.textContent = '无附件';
                    attched_brf.classList.add('hidden');
                    setAttachment(0);
                } else {
                    attched_tips.textContent = '附件:';
                    attched_num.textContent = `${attched_number}`;
                    attched_brf.classList.remove('hidden');
                    setAttachment(attched_number, blobUrl, attachment_name);
                }
            }


            // 添加附件
            function setAttachment(attched_number, blobUrl = '', attachment_name = '') {
                var attchment_links = document.getElementById('attchment');
                for (var i = 1; i <= attched_number; i++) {
                    attchment_links.innerHTML = attchment_links.innerHTML + `<div class="flex mb-1 overflow-hidden" style="max-width: calc(100vw - 110px);">【 <a class="overflow-hidden text-blue-500 overflow-ellipsis whitespace-nowrap" style="max-width:  calc(100% - 10px);" href="${blobUrl}" download="${attachment_name}">${attachment_name}</a>】</div>`;
                }
            }
        </script>
    </body>

</html>