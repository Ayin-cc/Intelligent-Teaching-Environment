<!DOCTYPE html>
<html lang="zh-CN">

	<head>
		<meta charset="UTF-8">
		<meta name="viewport" content="width=device-width, initial-scale=1.0">
		<link href="../css/output.css" rel="stylesheet" />
		<title>ITE-交流</title>
		<script src="../js/jquery-3.7.1.min.js"></script>
		<script src="../js/cookie-utils.js"></script>
		<script>
			var student;
			$(document).ready(async function () {
				// 检测cookie信息
				checkCookie();
				student = await getStudentObj();
				// 使用学生对象替换页面中的值
				const stdName = document.getElementById('name-profile');
				const stdID = document.getElementById('number-profile');
				stdName.innerText = student.name;
				stdID.innerText = student.sid;

				// keepAlive
				function keepAlive(callback) {
					setTimeout(function () {
						console.log("123");
						$.ajax({
							type: "POST",
							dataType: "json",
							url: 'http://162.14.107.35/SCUEE/ChatBox/keepAlive',
							contentType: "application/json",
							data: JSON.stringify({ "id": getCookie("courseId") }),
							success: function (result) {
								if (result != "") {
									for (var i = 0; i < result.length; i++) {
										setNewMessage(result[i].time, result[i].name, result[i].content);
									}
								}
							}
						})
						callback();
					}, 5000)
				}
				async function k() {
					keepAlive(k);
				}
				keepAlive(k);
			})
		</script>
	</head>

	<body class="bg-zinc-100">
		<!-- 顶部栏 -->
		<div class="flex flex-col bg-white">
			<div class="flex flex-row items-center justify-center">
				<!-- 头像栏 -->
				<div class="flex items-center justify-center max-w-sm p-2rounded-lg resizable ">
					<!-- 头像框 -->
					<div class="flex w-8 h-10 mx-4 my-3 overflow-hidden rounded-full " id="photo-profile">
						<img draggable="false" src="../icons/用户.svg" alt="" />
					</div>
					<div class="flex flex-col items-center justify-center overflow-hidden" style="max-width: 16rem;">
						<!-- 姓名 -->
						<div class="overflow-hidden text-center select-none overflow-ellipsis whitespace-nowrap"
							style="max-width: 16rem;" id="name-profile">
							XXXXXXXX
						</div>

						<!-- 学号 -->
						<div class="py-1 overflow-hidden text-xs text-center select-none overflow-ellipsis whitespace-nowrap"
							style="max-width: 16rem;" id="number-profile">
							202XXXXXXXXXXX
						</div>
					</div>
				</div>
				<a href="main.html"
					class="absolute items-center justify-end w-8 h-8 max-w-xs overflow-hidden rounded-h-full right-2"
					id="message-returnBottom">
					<img draggable="false" src="../icons/左.svg" alt="" />
				</a>
			</div>
			<!-- sidebar-line -->
			<div class="flex mx-2 w-auto h-0.5 bg-slate-400 "></div>
		</div>

		<div class="flex flex-col w-screen h-full overflow-y-scroll mb-14 bg-zinc-100" id="chat-container">
			<!-- 消息1 -->
			<!-- <div class="flex flex-col w-screen my-2">
				<div class="flex justify-center w-full py-2 text-xs text-zinc-600">
					8:15
				</div>
				<div class="flex flex-row w-screen overflow-x-hidden">
					<div class="flex w-10 h-10 p-1 ml-2 bg-purple-200 rounded-full">
						<img draggable="false" class="w-8 h-8" src="../icons/333/人员.svg">
					</div>
					<div class="flex flex-col w-full mx-3 overflow-x-hidden">
						<div class="text-sm truncate text-zinc-600 overflow-ellipsis whitespace-nowrap">
							系统
						</div>
						<div class="p-3 mt-1 break-words bg-white rounded-xl max-w-max"
							style="max-width: calc(100%-100px);">
							你是？
						</div>
					</div>
				</div>
			</div> -->
			<!-- 消息2 -->
			<!-- <div class="flex flex-col w-screen my-2">
				<div class="flex justify-center w-full py-2 text-xs text-zinc-600">
					8:16
				</div>
				<div class="flex flex-row w-screen overflow-x-hidden">
					<div class="flex flex-col items-end justify-end w-full mx-3 overflow-x-hidden text-end">
						<div class="p-3 mt-1 break-words bg-white rounded-xl max-w-max"
							style="max-width: calc(100%-100px);">
							你是？
						</div>
					</div>
					<div class="flex w-10 h-10 p-1 mr-2 bg-blue-100 rounded-full">
						<img draggable="false" class="w-8 h-8" src="../icons/333/人员.svg">
					</div>
				</div>
			</div> -->
		</div>
		<!-- 底部输入框 -->
		<div class="fixed bottom-0 flex items-center w-screen p-2 shadow-2xl shadow-slate-800">
			<input type="text" class="flex flex-grow p-2 border-0 input-box" id="message-input" placeholder="输入消息...">
			<button
				class="px-2 py-2 ml-3 text-gray-200 bg-blue-400 border-0 rounded-xl disabled:opacity-50 disabled:cursor-not-allowed"
				id="send-button">发送</button>
		</div>
		<script>
			// 获取元素
			const chatContainer = document.getElementById('chat-container');
			const messageInput = document.getElementById('message-input');
			const sendButton = document.getElementById('send-button');
			var lasttime = '00:00';
			// 发送消息函数
			function sendMessage() {
				const messageText = messageInput.value;
				const nowtime = getNowtime();
				if (messageText.trim() !== '') {
					let mes1 = `<div class="flex flex-col w-screen my-2">`;
					let mes2 = `<div class="flex justify-center w-full py-2 text-xs text-zinc-600">${nowtime}</div>`;
					let mes3 = `<div class="flex flex-row w-screen overflow-x-hidden">
					<div class="flex flex-col items-end justify-end w-full mx-3 overflow-x-hidden text-end">
						<div class="p-3 mt-1 break-words bg-white rounded-xl max-w-max"
							style="max-width: calc(100%-100px);">
							${messageText}
						</div>
					</div>
					<div class="flex w-10 h-10 p-1 mr-2 bg-blue-100 rounded-full">
						<img draggable="false" class="w-8 h-8" src="../icons/333/人员.svg">
					</div>
					</div>
				</div>`;

					// 发送请求，失败提示用户
					if (isLongtime(nowtime)) chatContainer.innerHTML = chatContainer.innerHTML + mes1 + mes2 + mes3;
					else chatContainer.innerHTML = chatContainer.innerHTML + mes1 + mes3;
					messageInput.value = '';
					isInput();

					// 发送到服务器
					var datetime = new Date(Date.now());
					$.ajax({
						type: "POST",
						dataType: "json",
						url: 'http://162.14.107.35/SCUEE/ChatBox/send',
						contentType: "application/json",
						data: JSON.stringify({
							"cid": getCookie("courseId"),
							"sid": student.sid,
							"name": student.name,
							"time": datetime,
							"content": messageText
						}),
						success: function (result) {
							if (result == 0) {
								// 发送失败
								alert("消息发送失败！");
							}
						}
					})
				}
			}

			// 接受新消息函数
			function setNewMessage(messageTime, messageTitle, messageText) {
				let mes1 = `<div class="flex flex-col w-screen my-2">`;
				let mes2 = `<div class="flex justify-center w-full py-2 text-xs text-zinc-600">${nowtime}</div>`;
				let mes3 = `<div class="flex flex-row w-screen overflow-x-hidden">
					<div class="flex w-10 h-10 p-1 ml-2 bg-purple-200 rounded-full">
						<img draggable="false" class="w-8 h-8" src="../icons/333/人员.svg">
					</div>
					<div class="flex flex-col w-full mx-3 overflow-x-hidden">
						<div class="text-sm truncate text-zinc-600 overflow-ellipsis whitespace-nowrap">
							${messageTitle}
						</div>
						<div class="p-3 mt-1 break-words bg-white rounded-xl max-w-max"
							style="max-width: calc(100%-100px);">
							${messageText}
						</div>
					</div>
				</div>
			</div>`;
				if (isLongtime(messageTime)) chatContainer.innerHTML = chatContainer.innerHTML + mes1 + mes2 + mes3;
				else chatContainer.innerHTML = chatContainer.innerHTML + mes1 + mes3;
			}

			// 初始化
			function setMessage() {
				// 调用 setNewMessage()
			}

			function getNowtime() {
				// 创建一个 Date 对象来获取当前本地时间
				const currentDate = new Date();

				// 获取年、月、日、小时、分钟和秒
				const hours = currentDate.getHours().toString().padStart(2, '0');
				const minutes = currentDate.getMinutes().toString().padStart(2, '0');

				// 构建时间字符串
				const formattedTime = `${hours}:${minutes}`;
				return formattedTime;
			}

			function isLongtime(nowtime) {
				// 解析时间字符串为 Date 对象
				const time1 = new Date(`2023-08-27T${nowtime}:00`);
				const time2 = new Date(`2023-08-27T${lasttime}:00`);

				// 计算时间差（毫秒）
				const timeDifference = Math.abs(time1 - time2);
				console.log('time:' + timeDifference);
				// 判断是否间隔超过5分钟
				if (timeDifference > 5 * 60 * 1000) {
					lasttime = nowtime;
					return 1;
				} else {
					return 0;
				}
			}

			// 监听发送按钮点击事件
			sendButton.addEventListener('click', sendMessage);

			// 监听输入框的回车键事件
			messageInput.addEventListener('keyup', function (event) {
				if (event.key === 'Enter') {
					sendMessage();
				}
			});

			// 输入框 是否已输入 监测
			function isInput() {
				const inputValue = messageInput.value;
				// 检查输入框是否有内容
				if (inputValue.trim() !== "") {
					// 有内容时启用按钮并添加相应的 Tailwind CSS 类
					sendButton.classList.remove("bg-blue-400");
					sendButton.classList.add("bg-blue-500");
					sendButton.disabled = false;
				} else {
					// 无内容时禁用按钮并还原样式
					sendButton.classList.remove("bg-blue-500");
					sendButton.classList.add("bg-blue-400");
					sendButton.disabled = true;
				}
			}

			messageInput.addEventListener("input", isInput);

		</script>
	</body>

</html>