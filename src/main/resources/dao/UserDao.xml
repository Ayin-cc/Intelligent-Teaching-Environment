<?xml version="1.0" encoding="UTF-8" ?>

<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="dao.UserDao">
    <resultMap id="studentResultMap" type="entity.Student">
        <result column="sid" property="sid" />
        <result column="student_token" property="token" />
        <result column="student_name" property="name" />
        <result column="student_major" property="major" />
        <result column="student_college" property="college" />
        <result column="student_sex" property="sex" />
        <result column="student_passwd" property="passwd" />
        <result column="student_phone" property="phone" />
    </resultMap>

    <resultMap id="msgResultMap" type="entity.Message">
        <result column="id" property="id" />
        <result column="title" property="title" />
        <result column="content" property="content" />
        <result column="msg_time" property="time" />
        <collection property="attachment">
            <result column="attachment_url" />
        </collection>
    </resultMap>

    <resultMap id="courseResultMap" type="entity.Course">
        <result column="id" property="courseId" />
        <result column="course_name" property="name" />
        <result column="course_teacher" property="teacher" />
        <result column="course_site" property="site" />
        <result column="startSection" property="startSection" />
        <result column="endSection" property="endSection" />
        <collection property="date" ofType="string">
            <result column="course_date" />
        </collection>
        <collection property="students" resultMap="studentResultMap" />
    </resultMap>

    <update id="updateStudent">
        update scuee.student s
        set s.student_name = #{student.name},
            s.student_major = #{student.major},
            s.student_college = #{student.college},
            s.student_sex = #{student.sex},
            s.student_passwd = #{student.passwd},
            s.student_phone = #{student.phone}
        where s.sid = #{student.sid};
    </update>

    <update id="updateTeacher">
        update scuee.teacher t
        set t.name = #{teacher.name},
            t.passwd = #{teacher.passwd},
            t.phone = #{teacher.phone}
        where t.id = #{teacher.id};
    </update>

    <insert id="addAdministrator">
        insert into scuee.administrator
            (id, passwd)
        values
            (#{administrator.id}, #{administrator.passwd});
    </insert>

    <update id="updateStudentToken">
        update scuee.student s
        set s.student_token = #{token}
        where s.sid = #{id};
    </update>

    <update id="updateClassroomToken">
        update scuee.classroom c
        set c.classroom_token = #{token}
        where c.cid = #{id};
    </update>

    <update id="updateAdministratorToken">
        update scuee.administrator a
        set a.token = #{token}
        where a.id = #{id};
    </update>

    <select id="queryStudent" resultType="java.lang.Integer">
        select exists(
            select * from scuee.student where sid = #{sid}
                   );
    </select>

    <select id="queryTeacher" resultType="java.lang.Integer">
        select exists(
            select * from scuee.teacher where id = #{id}
                   );
    </select>

    <select id="checkToken" resultType="java.lang.Integer">
        select exists(
            select * from scuee.administrator,scuee.classroom,scuee.student where token = #{token} or student_token = #{token} or classroom_token = #{token}
                   );
    </select>

    <select id="selectMsg" resultMap="msgResultMap">
        select scuee.message.*, scuee.msg_attachment.attachment_url
        from scuee.message
        inner join scuee.msg_attachment
        on msg_id = id
        where is_published = 1;
    </select>

    <select id="checkStudent" resultType="java.lang.Integer">
        select exists(
            select * from scuee.student where sid = #{student.sid} and student_passwd = #{student.passwd}
                   );
    </select>

    <select id="checkTeacher" resultType="java.lang.Integer">
        select exists(
            select * from scuee.teacher where id = #{teacher.id} and passwd = #{teacher.passwd}
                   );
    </select>

    <select id="checkAdministrator" resultType="java.lang.Integer">
        select exists(
            select * from scuee.administrator where id = #{administrator.id} and passwd = #{administrator.passwd}
                   );
    </select>

    <select id="selectCourse" resultMap="courseResultMap">
        select scuee.course.*, scuee.classroom_courses.course_date, scuee.course_students.student_id
        from(
            select * from scuee.classroom_courses where course_date = #{date}
            )cc
        inner join scuee.course c
        on cc.course_id = c.id
        inner join scuee.course_students cs
        on cc.course_id = cs.course_id;
    </select>

</mapper>