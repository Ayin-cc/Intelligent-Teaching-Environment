<?xml version="1.0" encoding="UTF-8" ?>

<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="dao.AdministratorDao">
    <resultMap id="studentResultMap" type="entity.Student">
        <result column="sid" property="sid" />
        <result column="student_token" property="token" />
        <result column="student_name" property="name" />
        <result column="student_major" property="major" />
        <result column="student_college" property="college" />
        <result column="student_sex" property="sex" />
        <result column="student_passwd" property="passwd" />
        <result column="student_phone" property="phone" />
    </resultMap>

    <resultMap id="classroomResultMap" type="entity.Classroom">
        <result column="cid" property="cid" />
        <result column="address" property="address" />
        <result column="classroom_token" property="token" />
        <collection property="courseSchedule" resultMap="courseResultMap" />
    </resultMap>

    <resultMap id="courseResultMap" type="entity.Course">
        <result column="id" property="courseId" />
        <result column="course_name" property="name" />
        <result column="course_teacher" property="teacher" />
        <result column="course_site" property="site" />
        <result column="startSection" property="startSection" />
        <result column="endSection" property="endSection" />
        <collection property="date" ofType="string">
            <result column="course_date" />
        </collection>
        <collection property="students" resultMap="studentResultMap" />
    </resultMap>

    <insert id="addStudent">
        insert into scuee.student
            (sid, student_token, student_name, student_major, student_college, student_sex, student_passwd, student_phone)
        values
            (#{student.sid}, #{student.token}, #{student.name}, #{student.major}, #{student.college}, #{student.sex}, #{student.passwd}, #{student.phone});
    </insert>

    <insert id="addClassroom">
        insert into scuee.classroom
            (cid, address, classroom_token)
        values
            (#{classroom.cid}, #{classroom.address}, #{classroom.token});
    </insert>

    <insert id="addCourseInf">
        insert into scuee.course
            (id, course_name, course_teacher, course_site, start_section, end_section)
        values
            (#{course.courseId}, #{course.name}, #{course.teacher}, #{course.site}, #{course.startSection}, #{course.endSection});
    </insert>

    <insert id="addCourseSchedule">
        insert into scuee.classroom_courses
                (cid, course_section, course_id, course_date)
        values
            (#{cid}, #{section}, #{id}, #{date});
    </insert>

    <insert id="addStudentToCourse">
        insert into scuee.course_students
            (course_id, student_id)
        values
            (#{id}, #{sid});
    </insert>

    <update id="changeStudent">
        update scuee.student s
        set
            s.student_token = #{student.token},
            s.student_name = #{student.name},
            s.student_major = #{student.major},
            s.student_college = #{student.college},
            s.student_sex = #{student.sex},
            s.student_passwd = #{student.passwd},
            s.student_phone = #{student.phone}
        where
            s.sid = #{student.sid};
    </update>

    <update id="changeClassroom">
        update scuee.classroom c
        set
            c.address = #{classroom.address}
        where
            c.cid = #{classroom.cid};
    </update>

    <update id="changeCourseInf">
        update scuee.course c
        set
            c.course_name = #{course.name},
            c.course_teacher = #{course.teacher},
            c.course_site = #{course.site},
            c.start_section = #{course.startSection},
            c.end_section = #{course.endSection}
        where
            c.id = #{course.courseId};
    </update>

    <update id="changeCourseSchedule">
        update scuee.classroom_courses cc
        set
            cc.cid = #{cid},
            cc.course_date = #{date},
            cc.course_section = #{section}
        where
            cc.course_id = #{id};
    </update>

    <delete id="deleteStudent">
        delete from scuee.student s
        where s.sid = #{student.sid};
    </delete>

    <delete id="deleteClassroom">
        delete from scuee.classroom c
        where  c.cid = #{classroom.cid};
    </delete>

    <delete id="deleteCourseInf">
        delete from scuee.course c
        where c.id = #{course.courseId};
    </delete>

    <delete id="deleteCourseSchedule">
        delete from scuee.classroom_courses cc
        where cc.course_id = #{id};
    </delete>

    <delete id="deleteStudentFromCourse">
        delete from scuee.course_students
        where student_id = #{sid} and course_id = #{id};
    </delete>

    <select id="checkToken" resultType="java.lang.Integer">
        select exists(
            select * from scuee.administrator a where a.token = #{token}
                   );
    </select>

    <select id="queryStudent" resultMap="studentResultMap">
        select *
        from scuee.student s
        where
            <if test="sid != null">
                s.sid = #{sid}
            </if>
            <if test="name != null">
                and s.student_name like concat('%', #{name}, '%')
            </if>
            <if test="major != null">
                and s.student_major like concat('%', #{major}, '%')
            </if>
            <if test="college != null">
                and s.student_college like concat('%', #{college}, '%')
            </if>
            <if test="phone != null">
                and s.student_phone like concat(#{phone}, '%')
            </if>;
    </select>

    <select id="queryClassroom" resultMap="classroomResultMap">
        select *
        from scuee.classroom c
        where 
            <if test="cid != null">
                c.cid = #{cid}
            </if>
            <if test="address != null">
                and c.address like concat(#{address}, '%')
            </if>;
    </select>

    <select id="queryCourse" resultMap="courseResultMap">
        select scuee.course.*, scuee.classroom_courses.course_date, scuee.course_students.student_id
        from (
            select *
            from scuee.course
            where
                <if test="id != null">
                    id = #{id}
                </if>
                <if test="name != null">
                    and course_name like concat('%', #{name}, '%')
                </if>
                <if test="teacher != null">
                    and course_teacher like concat('%', #{teacher}, '%')
                </if>
             )c
        inner join classroom_courses cc
        on course.id = cc.course_id
        inner join course_students cs
        on c.id = cs.course_id
    </select>

    <select id="selectCidBySite" resultType="java.lang.String">
        select *
        from scuee.classroom c
        where c.address = #{site};
    </select>

</mapper>