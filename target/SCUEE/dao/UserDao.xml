<?xml version="1.0" encoding="UTF-8" ?>

<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="dao.UserDao">
    <resultMap id="studentResultMap" type="entity.Student">
        <result column="sid" property="sid" />
        <result column="student_name" property="name" />
        <result column="student_major" property="major" />
        <result column="student_college" property="college" />
        <result column="student_sex" property="sex" />
        <result column="student_phone" property="phone" />
    </resultMap>

    <resultMap id="attachmentResultMap" type="entity.Attachment">
        <result column="msg_id" property="id"/>
        <result column="attachment_name" property="name" />
        <result column="attachment_url" property="blob" jdbcType="BLOB" typeHandler="org.apache.ibatis.type.BlobTypeHandler"/>
    </resultMap>

    <resultMap id="msgResultMap" type="entity.Message">
        <result column="id" property="id" />
        <result column="title" property="title" />
        <result column="content" property="content" />
        <result column="msg_time" property="time" />
        <result column="sender" property="sender"/>
        <collection property="attachment" resultMap="attachmentResultMap"/>
    </resultMap>

    <resultMap id="courseResultMap" type="entity.Course">
        <result column="id" property="courseId" />
        <result column="course_name" property="name" />
        <result column="course_teacher" property="teacher" />
        <result column="course_site" property="site" />
        <result column="start_section" property="startSection" />
        <result column="end_section" property="endSection" />
        <collection property="date" ofType="string">
            <result column="course_date" />
        </collection>
        <collection property="students" resultMap="studentResultMap" />
    </resultMap>

    <update id="updateStudent">
        update scuee.student
        set student.student_name = #{student.name},
            student.student_major = #{student.major},
            student.student_college = #{student.college},
            student.student_sex = #{student.sex},
            student.student_passwd = #{student.passwd},
            student.student_phone = #{student.phone}
        where student.sid = #{student.sid};
    </update>

    <update id="updateTeacher">
        update scuee.teacher
        set teacher.name = #{teacher.name},
            teacher.passwd = #{teacher.passwd},
            teacher.phone = #{teacher.phone}
        where teacher.id = #{teacher.id};
    </update>

    <insert id="addAdministrator">
        insert into scuee.administrator
            (id, passwd)
        values
            (#{administrator.id}, #{administrator.passwd});
    </insert>

    <update id="updateStudentToken">
        update scuee.student
        set student.student_token = #{token}
        where student.sid = #{id};
    </update>

    <update id="updateClassroomToken">
        update scuee.classroom
        set classroom.classroom_token = #{token}
        where classroom.cid = #{id};
    </update>

    <update id="updateAdministratorToken">
        update scuee.administrator
        set administrator.token = #{token}
        where administrator.id = #{id};
    </update>

    <select id="queryStudent" resultType="java.lang.Integer">
        select exists(
            select * from scuee.student where sid = #{sid}
                   );
    </select>

    <select id="queryTeacher" resultType="java.lang.Integer">
        select exists(
            select * from scuee.teacher where id = #{id}
                   );
    </select>

    <select id="checkToken" resultType="java.lang.Integer">
        select exists(
            select * from scuee.administrator,scuee.classroom,scuee.student where token = #{token} or student_token = #{token} or classroom_token = #{token}
                   );
    </select>

    <select id="selectMsg" resultMap="msgResultMap">
        select *
        from scuee.message
        inner join scuee.msg_attachment
        on id = id
        where is_published = 1;
    </select>

    <select id="checkStudent" resultType="java.lang.Integer">
        select exists(
            select * from scuee.student where sid = #{student.sid} and student_passwd = #{student.passwd}
                   );
    </select>

    <select id="checkTeacher" resultType="java.lang.Integer">
        select exists(
            select * from scuee.teacher where id = #{teacher.id} and passwd = #{teacher.passwd}
                   );
    </select>

    <select id="checkAdministrator" resultType="java.lang.Integer">
        select exists(
            select * from scuee.administrator where id = #{administrator.id} and passwd = #{administrator.passwd}
                   );
    </select>

    <select id="selectCourse" resultMap="courseResultMap">
        select scuee.course.*, scuee.classroom_courses.course_date, scuee.course_students.student_id
        from(
            select * from scuee.classroom_courses where course_date = #{date}
            )cc
        inner join scuee.course
        on cc.course_id = course.id
        inner join scuee.course_students
        on cc.course_id = course_students.course_id;
    </select>

    <select id="selectStudentById" resultType="entity.Student">
        select *
        from scuee.student
        where student.sid = #{sid};
    </select>

</mapper>