<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>二维码查询</title>
    <!-- 引入Bootstrap CSS文件 -->
    <link rel="stylesheet" href="https://cdn.staticfile.org/twitter-bootstrap/4.3.1/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://cdn.staticfile.org/bootstrap-daterangepicker/3.0.5/daterangepicker.css">

    <script src="../js/cookie-utils.js"></script>

    <script src="../js/jquery-3.7.1.min.js"></script>
    <script src="https://cdn.staticfile.org/twitter-bootstrap/4.3.1/js/bootstrap.min.js"></script>
    <script src="https://cdn.staticfile.org/bootstrap-daterangepicker/3.0.5/daterangepicker.min.js">

    </script>
    <script>
        $(document).ready(function() {
            checkCookie();

            // 获取查询表单元素，并设置其提交事件的回调函数为处理查询表单的提交事件的函数
            $("#query-form").submit(sendQueryRequest());
        });
    </script>
</head>
<body>
<div class="container">
    <h1 class="text-center">二维码查询</h1>
    <form id="query-form">

        <div class="form-group row">
            <label for="course-name-input" class="col-sm-2 col-form-label">课程名称</label>
            <div class="col-sm-10">
                <input type="text" class="form-control" id="course-name-input" placeholder="请输入课程名称" name="courseName">
            </div>
        </div>

        <div class="form-group row">
            <label for="cid" class="col-sm-2 col-form-label">教室ID</label>
            <div class="col-sm-10">
                <input type="text" class="form-control" id="cid-input" placeholder="请输入教室ID" name="cid">
            </div>
        </div>

        <div class="form-group row">
            <label for="time-input" class="col-sm-2 col-form-label">时间</label>
            <div class="col-sm-10">
                <!-- 使用Bootstrap日期选择器组件 -->
                <input type="text" class="form-control" id="time-input" placeholder="请选择时间范围" data-toggle="daterangepicker" name="date">
            </div>
        </div>


        <div class="form-group row">
            <label for="course-id-input" class="col-sm-2 col-form-label">课程号</label>
            <div class="col-sm-10">
                <input type="text" class="form-control" id="course-id-input" placeholder="请输入课程号" name="courseId">
            </div>
        </div>


        <div class="form-group row">
            <label for="teacher-name-input" class="col-sm-2 col-form-label">教师姓名</label>
            <div class="col-sm-10">
                <input type="text" class="form-control" id="teacher-name-input" placeholder="请输入教师姓名" name="teacher">
            </div>
        </div>


        <button type="submit" class="btn btn-primary">查询</button>

    </form>

    <table id="result-table" class="table table-striped table-bordered table-hover mt-3 d-none">
        <thead>
        <tr>
            <th>课程号</th>
            <th>课程名称</th>
            <th>教室ID</th>
            <th>时间</th>
            <th>教师姓名</th>
            <th>详情</th>
        </tr>
        </thead>
        <tbody></tbody>
    </table>


    <div id="detail-modal" class="modal fade" tabindex="-1" role="dialog">
        <div class="modal-dialog modal-lg modal-dialog-centered" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">二维码详情</h5>

                    <img id= "code-img" src="" alt="" width=100 height=100 style= "margin-left: auto;">


                    <button type= "button" class= "close" data-dismiss= "modal">×</button>
                </div>

                <table id= "detail-table" class= "table table-striped table-bordered table-hover mt-3 d-none">

                    <thead>

                    <tr>
                        <th>code</th>
                        <th>courseId</th>
                        <th>courseName</th>
                        <th>teacher</th>
                        <th>cid</th>
                        <th>uid</th>
                        <th>time</th>
                        <th>count</th>
                        <th>sid</th>
                        <th>endTime</th>
                    </tr>
                    </thead>
                    <tbody>
                    <tr>
                        <td id= "code"></td>
                        <td id= "courseId"></td>
                        <td id= "courseName"></td>
                        <td id= "teacher"></td>
                        <td id= "cid"></td>
                        <td id= "uid"></td>
                        <td id= "time"></td>
                        <td id= "count"></td>
                        <td id= "sid"></td>
                        <td id= "endTime"></td>
                    </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

</div>

<script>



    // 发送查询请求
    function sendQueryRequest() {
        var queryData = new FormData();
        queryData.append("courseName", $("#course-name-input").value);
        queryData.append("cid", $("#cid-input").value);
        queryData.append("date", $("#time-input").value);
        queryData.append("courseId", $("#course-id-input").value);
        queryData.append("teacher", $("#teacher-name-input").value);
        // 使用jQuery的ajax方法来发送异步请求
        $.ajax({
            url: "http://162.14.107.35/SCUEE/QRCode/query",
            type: "POST",
            data: queryData,
            contentType: false,
            processData:false,
            headers:{"Authorization":getCookie("token")},
            success: function(data) {
                handleQueryResult(data);
            },
            error: function(error) {
                alert(error.responseText);
            }
        });
    }

    // 处理查询结果
    function handleQueryResult(data) {

        var resultTable = $("#result-table");
        var resultTableBody = $("#result-table tbody");
        resultTableBody.empty();
        // 判断查询结果是否为空
        if (data.length == 0) {
            alert("无符合条件的数据");
            resultTable.addClass("d-none");
        } else {//显示获取的数据
            for (var i = 0; i < data.length; i++) {
                var qrCode = data[i];
                var tr = $("<tr></tr>");
                var tdCourseId = $("<td></td>").text(qrCode.courseId);
                var tdCourseName = $("<td></td>").text(qrCode.courseName);
                var tdCid = $("<td></td>").text(qrCode.cid);
                var tdTime = $("<td></td>").text(qrCode.time);
                var tdTeacher = $("<td></td>").text(qrCode.teacher);

                //详情按钮
                var btnDetail = $("<button></button>").text("详情").addClass("btn btn-info").click(function() {
                    showDetailInfo(qrCode);
                });
                var tdDetail = $("<td></td>").append(btnDetail);
                tr.append(tdCourseId, tdCourseName, tdCid, tdTime, tdTeacher, tdDetail);
                resultTableBody.append(tr);
            }
            // 显示结果表格元素
            resultTable.removeClass("d-none");
        }
    }

    // 显示详情信息
    function showDetailInfo(qrCode) {
        // 获取模态框元素
        var detailModal = $("#detail-modal");
        var codeImg = $("#code-img").attr("src", qrCode.code);//二维码显示（待删除）

        var code = $("#code").text(qrCode.code);
        var courseId = $("#courseId").text(qrCode.courseId);
        var courseName = $("#courseName").text(qrCode.courseName);
        var teacher = $("#teacher").text(qrCode.teacher);
        var cid = $("#cid").text(qrCode.cid);
        var uid = $("#uid").text(qrCode.uid);
        var time = $("#time").text(qrCode.time);
        var count = $("#count").text(qrCode.count);
        var sid = $("#sid").text(qrCode.sid.join(", "));
        var endTime = $("#endTime").text(qrCode.endTime);
        detailModal.modal("show");
    }
</script>

</body>
</html>