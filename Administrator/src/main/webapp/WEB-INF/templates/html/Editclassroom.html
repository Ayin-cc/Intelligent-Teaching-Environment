<html>
<head>
  <meta charset="utf-8">
  <title>教室信息管理</title>
  <link rel="stylesheet" href="https://cdn.staticfile.org/twitter-bootstrap/4.3.1/css/bootstrap.min.css">
  <script src="../js/jquery-3.7.1.min.js"></script>
  <script src="../js/cookie-utils.js"></script>
  <script src="https://cdn.staticfile.org/twitter-bootstrap/4.3.1/js/bootstrap.min.js"></script>
  <script>
    $(document).ready(function() {
      checkCookie();
      document.getElementById("username-profile").innerText = student.name;

      // 绑定提交
      $("#search-form").submit(function(event) {
        event.preventDefault();

        // 调用函数，根据搜索表单的值发送Ajax请求，并显示返回的数据
        searchAndShow();
      });

      // 绑定添加按钮
      $("#add-btn").click(function() {
        $("#add-modal").modal("show");
      });

      // 绑定添加模态框的确认按钮
      $("#add-confirm-btn").click(function() {
        var addForm = $("#add-form");
        var addData = addForm.serializeObject();

        // 发送Ajax请求，传递添加表单的数据
        $.ajax({
          url: "http://162.14.107.35/SCUEE/Administrator/addClassroom",
          type: "POST",
          data: JSON.stringify(addData),
          dataType: "json",
          contentType:"application/json",
          headers:{"Authorization":getCookie("token")},
          success: function(data) {
            if (typeof data === "object") {
              $("#add-modal").modal("hide");
              alert(data.message || "添加成功！");
              searchAndShow();
            } else {
              alert(data.message || "添加失败，请重试！");
            }
          },
          error: function() {
            alert("请求失败，请重试！");
          }
        });
      });

      $("#upload-confirm-btn").click(function() {
        var uploadForm = $("#upload-form")[0];
        var uploadData = new FormData(uploadForm);

        // 发送Ajax请求，传递上传表单的数据
        $.ajax({
          url: "http://162.14.107.35/SCUEE/Administrator/changeClassroom",
          type: "POST",
          data: JSON.stringify(uploadData),
          dataType: "json",
          contentType: "application/json",
          headers:{"Authorization":getCookie("token")},
          success: function(data) {
            if (typeof data === "object") {
              $("#upload-modal").modal("hide");
              alert(data.message || "上传成功！");
              // 调用函数，根据搜索表单的值发送Ajax请求，并显示返回的数据
              searchAndShow();
            } else {
              alert(data.message || "上传失败，请重试！");
            }
          },
          error: function() {
            alert("请求失败，请重试！");
          }
        });
      });

      // 绑定编辑按钮
      $("#show-table tbody").on("click", "button.btn-warning", function() {

        var tr = $(this).closest("tr");
        var classroom = {};
        classroom.cid = tr.children().eq(0).text();
        classroom.address = tr.children().eq(1).text();
        classroom.courseSchedule = tr.children().eq(2).text().split(",").map(function(name) {
          var course = {};
          course.name = name;
          return course;
        });
        fillEditForm(classroom);
        var editTbody = $("#edit-course-table tbody");
        editTbody.empty();
        for (var i = 0; i < classroom.courseSchedule.length; i++) {
          var course = classroom.courseSchedule[i];
          var tr = createEditCourseTableRow(course);
          editTbody.append(tr);
        }
        $("#edit-modal").modal("show");
      });
    });
  </script>
</head>

<body>
<div class="container">
  <h1 class="text-center">教室信息管理</h1>

  <form id="search-form" class="form-inline">
    <div class="form-group">
      <label for="cid">教室id</label>
      <input type="text" class="form-control" id="cid" name="cid" placeholder="请输入教室id">
    </div>
    <div class="form-group">
      <label for="address">地址</label>
      <input type="text" class="form-control" id="address" name="address" placeholder="请输入地址">
    </div>
    <button type = "submit" class = "btn btn-primary">搜索</button>
  </form>
  <button type="button" class="btn btn-primary" onclick="window.location='DataManage.html'">返回</button>


  <button id = "add-btn" class = "btn btn-success">添加</button>
  <table id = "show-table" class = "table table-striped table-bordered table-hover">
    <thead>
    <tr>
      <th>教室id</th>
      <th>地址</th>
      <th>课程安排</th>
      <th>操作</th>
    </tr>
    </thead>
    <tbody></tbody>
  </table>

  <div id = "edit-modal" class = "modal fade">
    <div class = "modal-dialog modal-lg">
      <div class = "modal-content">
        <div class = "modal-header">
          <h4 class = "modal-title">编辑教室信息</h4>
          <button type = "button" class = "close" data-dismiss = "modal">×</button>
        </div>

        <div class = "modal-body">
          <form id = "edit-form" class = "form-horizontal">
            <!-- 教室id -->
            <div class = "form-group row">
              <label for = "edit-cid" class = "col-sm-2 col-form-label">教室id</label>
              <div class = "col-sm-10">
                <input type = "text" readonly class = "form-control-plaintext" id = "edit-cid">
              </div>
            </div>

            <!-- 地址 -->
            <div class = "form-group row">
              <label for = "edit-address" class = "col-sm-2 col-form-label">地址</label>
              <div class = "col-sm-10">
                <input type = "text" class = "form-control" id = "edit-address">
              </div>
            </div>

            <!-- 课程安排 -->
            <input type = "hidden" id = "edit-courseSchedule" name = "courseSchedule">
            <table id = "edit-course-table" class = "table table-striped table-bordered table-hover">
              <thead>
              <tr>
                <th>课程号</th>
                <th>名字</th>
                <th>教师</th>
                <th>上课时间</th>
                <th>开始节次</th>
                <th>结束节次</th>
                <th>操作</th>
              </tr>
              </thead>
              <tbody></tbody>
            </table>

            <button id = "edit-add-course-btn" type = "button" class = "btn btn-success">添加课程</button>

          </form>
        </div>

        <div class="modal-footer">

          <button id="confirm-btn" type="button" class="btn btn-primary">确认</button>
          <button type="button" class="btn btn-secondary" data-dismiss="modal">取消</button>
        </div>
      </div>
    </div>
  </div>

  <div id="add-modal" class="modal fade">
    <div class="modal-dialog modal-lg">
      <div class="modal-content">
        <div class="modal-header">
          <h4 class="modal-title">添加教室信息</h4>

          <button type="button" class="close" data-dismiss="modal">×</button>
        </div>

        <div class="modal-body">
          <form id="add-form" class="form-horizontal">
            <!-- 教室id -->
            <div class="form-group row">
              <label for="add-cid" class="col-sm-2 col-form-label">教室id</label>
              <div class="col-sm-10">
                <input type="text" class="form-control" id="add-cid">
              </div>
            </div>

            <!-- 地址 -->
            <div class="form-group row">
              <label for="add-address" class="col-sm-2 col-form-label">地址</label>
              <div class="col-sm-10">
                <input type="text" class="form-control" id="add-address">
              </div>
            </div>

            <!-- 课程安排 -->

            <input type = "hidden" id = "add-courseSchedule" name = "courseSchedule">
            <table id = "add-course-table" class = "table table-striped table-bordered table-hover">
              <thead>
              <tr>
                <th>课程号</th>
                <th>名字</th>
                <th>教师</th>
                <th>上课时间</th>
                <th>开始节次</th>
                <th>结束节次</th>
                <th>操作</th>
              </tr>
              </thead>
              <tbody></tbody>
            </table>


            <button id = "add-add-course-btn" type = "button" class = "btn btn-success">添加课程</button>

          </form>
        </div>

        <div class = "modal-footer">

          <button id = "add-confirm-btn" type = "button" class = "btn btn-primary">确认</button>
          <button type = "button" class = "btn btn-secondary" data-dismiss = "modal">取消</button>
        </div>
      </div>
    </div>
  </div>


  <div id = "upload-modal" class = "modal fade">
    <div class = "modal-dialog modal-lg">
      <div class = "modal-content">
        <div class = "modal-header">
          <h4 class = "modal-title">上传教室信息</h4>

          <button type = "button" class = "close" data-dismiss = "modal">×</button>
        </div>

        <!-- 文件选择 -->
        <div class = "modal-body">
          <form id = "upload-form" class = "form-horizontal" enctype="multipart/form-data">
            <div class = "form-group row">
              <label for = "file" class = "col-sm-2 col-form-label">选择文件</label>

              <div class = "col-sm-10">
                <input type = "file" class = "form-control-file" id = "file" name="file">
              </div>
            </div>
          </form>
        </div>

        <div class="modal-footer">

          <button id="upload-confirm-btn" type="button" class="btn btn-primary">确认</button>
          <button type="button" class="btn btn-secondary" data-dismiss="modal">取消</button>
        </div>
      </div>
    </div>
  </div>


  <script>
    var student = new Object();

    function createTableRow(classroom) {
      var tr = $("<tr></tr>");
      var cidTd = $("<td></td>").text(classroom.cid);
      var addressTd = $("<td></td>").text(classroom.address);
      var courseScheduleTd = $("<td></td>").text(classroom.courseSchedule.map(function(course) {
        return course.name;
      }).join(","));

      var editBtn = $("<button></button>").addClass("btn btn-warning").text("编辑");
      var deleteBtn = $("<button></button>").addClass("btn btn-danger").text("删除");
      var opTd = $("<td></td>").append(editBtn).append(deleteBtn);

      tr.append(cidTd).append(addressTd).append(courseScheduleTd).append(opTd);

      return tr;
    }

    //根据教室对象填充编辑表单
    function fillEditForm(classroom) {
      var editCid = $("#edit-cid");
      var editAddress = $("#edit-address");
      var editCourseSchedule = $("#edit-courseSchedule");
      editCid.val(classroom.cid);
      editAddress.val(classroom.address);
      editCourseSchedule.val(JSON.stringify(classroom.courseSchedule));
    }

    // 生成编辑课程表格
    function createEditCourseTableRow(course) {
      var tr = $("<tr></tr>");
      var courseIdTd = $("<td></td>").text(course.courseId);
      var nameTd = $("<td></td>").text(course.name);
      var teacherTd = $("<td></td>").text(course.teacher);

      var dateTd = $("<td></td>").text(course.date.join(","));
      var startSectionTd = $("<td></td>").text(course.startSection);
      var endSectionTd = $("<td></td>").text(course.endSection);

      var editBtn = $("<button></button>").addClass("btn btn-warning").text("编辑");
      var deleteBtn = $("<button></button>").addClass("btn btn-danger").text("删除");
      var opTd = $("<td></td>").append(editBtn).append(deleteBtn);

      tr.append(courseIdTd).append(nameTd).append(teacherTd).append(dateTd).append(startSectionTd).append(endSectionTd).append(opTd);

      return tr;
    }

    $.fn.serializeObject = function(){
      var o = {};
      var a = this.serializeArray();
      $.each(a, function() {
        if (o[this.name] !== undefined) {
          if (!o[this.name].push) {
            o[this.name] = [o[this.name]];
          }
          o[this.name].push(this.value || '');
        } else {
          o[this.name] = this.value || '';
        }
      });
      return o;
    }

    // 定义一个函数，用于根据搜索表单的值发送Ajax请求，并显示返回的数据
    function searchAndShow() {
      var searchForm = $("#search-form");
      var searchData = searchForm.serializeObject();
      $.ajax({
        url: "http://162.14.107.35/SCUEE/Administrator/queryClassroom",
        type: "POST",
        contentType: "application/json",
        data: JSON.stringify(searchData),
        headers:{"Authorization":getCookie("token")},
        dataType: "json",
        success: function(data) {
          if (data) {//判断返回值待确定
            var showTbody = $("#show-table tbody");
            showTbody.empty();
            for (var i = 0; i < data.length; i++) {
              var classroom = data[i];
              var tr = createTableRow(classroom);
              showTbody.append(tr);
            }
          } else {
            alert(data.message || "查询失败，请重试！");
          }
        },
        error: function() {
          alert("请求失败，请重试！");
        }
      });
    }
  </script>
</div>
</body>
</html>